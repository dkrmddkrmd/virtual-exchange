<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>가상 주식 거래소</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

<h1 class="mb-4">📈 실시간 주식 시세</h1>

<table class="table table-hover table-bordered align-middle">
    <thead class="table-dark">
    <tr>
        <th>종목 코드</th>
        <th>종목명</th>
        <th>현재가 (KRW)</th>
        <th>주문 (매수/매도)</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="stock : ${stocks}">
        <td th:text="${stock.code}">KRW-BTC</td>
        <td th:text="${stock.name}">비트코인</td>
        <td th:text="${#numbers.formatInteger(stock.currentPrice, 0, 'COMMA')} + ' 원'">100,000,000 원</td>

        <td>
            <div class="d-flex gap-2">
                <input type="number" class="form-control" style="width: 80px;"
                       th:id="|quantity_${stock.code}|" placeholder="수량" value="1">

                <button class="btn btn-success btn-sm"
                        th:data-code="${stock.code}"
                        onclick="orderStock(this.getAttribute('data-code'), 'BUY')">
                </button>

                <button class="btn btn-danger btn-sm"
                        th:data-code="${stock.code}"
                        onclick="orderStock(this.getAttribute('data-code'), 'SELL')">
                </button>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<script>
    // 1. 유저 ID 관리: 나중에 로그인이 구현되면 이 부분만 수정하면 됩니다.
    const CURRENT_USER_ID = 29;

    // 2. 통합된 주문 함수
    function orderStock(code, type) {
        // 수량 가져오기
        const quantityInput = document.getElementById('quantity_' + code);
        const quantity = quantityInput.value;

        // 유효성 검사 (수량이 없거나 0 이하일 때)
        if (!quantity || quantity <= 0) {
            alert("올바른 수량을 입력해주세요.");
            return;
        }

        // 백엔드 DTO(OrderRequestDto) 구조에 맞게 데이터 생성
        // orderType: "BUY" 또는 "SELL" 문자열이 백엔드의 Enum으로 자동 변환됨
        const requestData = {
            userId: CURRENT_USER_ID,
            code: code,
            quantity: Number(quantity),
            orderType: type
        };

        // 매수/매도 구분 없이 하나의 주소로 전송
        fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
            .then(async response => {
                if (response.ok) {
                    // 성공 메시지 출력 (응답 본문에 메시지가 있으면 그것을, 없으면 기본 메시지)
                    const msg = await response.text();
                    alert(msg || (type === 'BUY' ? "매수 성공!" : "매도 성공!"));
                    window.location.reload(); // 새로고침해서 잔고/보유량 갱신 확인
                } else {
                    // 백엔드에서 보낸 에러 메시지(예: 잔액 부족 등) 출력
                    const errorMsg = await response.text();
                    alert("주문 실패: " + errorMsg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("서버 통신 중 오류가 발생했습니다.");
            });
    }
</script>

</body>
</html>